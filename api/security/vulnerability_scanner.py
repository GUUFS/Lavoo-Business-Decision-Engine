"""
Vulnerability Scanner for FastAPI Application
Scans for security vulnerabilities in dependencies, database, configuration, and API endpoints
"""

from sqlalchemy.orm import Session
from sqlalchemy import text
import subprocess
import json
import os
from datetime import datetime
from typing import List, Dict, Any
from config.logging import get_logger

logger = get_logger(__name__)


class VulnerabilityFinding:
    def __init__(self, severity: str, type: str, description: str, 
                 recommendation: str, location: str = None):
        self.severity = severity  # critical, high, medium, low
        self.type = type
        self.description = description
        self.recommendation = recommendation
        self.location = location
    
    def to_dict(self):
        return {
            'severity': self.severity,
            'type': self.type,
            'description': self.description,
            'recommendation': self.recommendation,
            'location': self.location
        }


class VulnerabilityScanner:
    def __init__(self):
        self.scan_in_progress = False
    
    async def run_full_scan(self, db: Session) -> Dict[str, Any]:
        """Run complete vulnerability scan"""
        if self.scan_in_progress:
            logger.warning("Scan already in progress")
            return {'status': 'already_running'}
        
        self.scan_in_progress = True
        start_time = datetime.now()
        findings: List[VulnerabilityFinding] = []
        
        try:
            logger.info("Starting vulnerability scan")
            
            # Create scan record
            result = db.execute(text("""
                INSERT INTO vulnerability_scans (scan_type, status, started_at)
                VALUES (:type, :status, NOW())
                RETURNING id
            """), {'type': 'Full System Scan', 'status': 'in_progress'})
            scan_id = result.fetchone()[0]
            db.commit()
            
            # Run all checks
            findings.extend(await self.check_database_security(db))
            findings.extend(await self.check_configuration_security())
            findings.extend(await self.check_python_dependencies())
            
            # Calculate overall severity
            severity = self._calculate_overall_severity(findings)
            duration = int((datetime.now() - start_time).total_seconds())
            
            # Update scan record
            db.execute(text("""
                UPDATE vulnerability_scans 
                SET status = :status, severity = :severity, findings = :findings,
                    scan_results = :results, completed_at = NOW(), duration_seconds = :duration
                WHERE id = :id
            """), {
                'status': 'completed',
                'severity': severity,
                'findings': len(findings),
                'results': json.dumps([f.to_dict() for f in findings]),
                'duration': duration,
                'id': scan_id
            })
            db.commit()
            
            logger.info(f"Vulnerability scan completed: {len(findings)} findings, severity={severity}")
            
            return {
                'status': 'completed',
                'scan_id': scan_id,
                'findings': len(findings),
                'severity': severity,
                'duration': duration
            }
            
        except Exception as e:
            logger.error(f"Vulnerability scan failed: {e}")
            return {'status': 'failed', 'error': str(e)}
        finally:
            self.scan_in_progress = False
    
    
    async def check_database_security(self, db: Session) -> List[VulnerabilityFinding]:
        """Check database security issues"""
        findings = []
        
        try:
            logger.info("Checking database security")
            
            # Check for weak passwords
            result = db.execute(text("""
                SELECT COUNT(*) as count FROM users 
                WHERE LENGTH(password) < 60
            """))
            weak_passwords = result.fetchone()[0]
            
            if weak_passwords > 0:
                findings.append(VulnerabilityFinding(
                    severity='high',
                    type='weak_password_policy',
                    description=f"{weak_passwords} users with potentially weak password hashes",
                    recommendation='Enforce strong password policy and rehash passwords'
                ))
            
            # Check for users without roles
            result = db.execute(text("""
                SELECT COUNT(*) as count FROM users 
                WHERE role IS NULL OR role = ''
            """))
            no_role = result.fetchone()[0]
            
            if no_role > 0:
                findings.append(VulnerabilityFinding(
                    severity='medium',
                    type='missing_user_roles',
                    description=f"{no_role} users without assigned roles",
                    recommendation='Assign proper roles to all users'
                ))
            
            # Check for old active sessions
            result = db.execute(text("""
                SELECT COUNT(*) as count FROM user_sessions 
                WHERE is_active = true 
                AND last_activity < NOW() - INTERVAL '30 days'
            """))
            old_sessions = result.fetchone()[0]
            
            if old_sessions > 0:
                findings.append(VulnerabilityFinding(
                    severity='low',
                    type='stale_sessions',
                    description=f"{old_sessions} active sessions older than 30 days",
                    recommendation='Run session cleanup to remove stale sessions'
                ))
            
        except Exception as e:
            logger.error(f"Database security check failed: {e}")
        
        return findings
    
    async def check_configuration_security(self) -> List[VulnerabilityFinding]:
        """Check configuration security"""
        findings = []
        
        try:
            logger.info("Checking configuration security")
            
            # Check JWT secret strength
            jwt_secret = os.getenv('JWT_SECRET', '')
            if len(jwt_secret) < 32:
                findings.append(VulnerabilityFinding(
                    severity='critical',
                    type='weak_jwt_secret',
                    description='JWT secret is too short (less than 32 characters)',
                    recommendation='Generate a strong random JWT secret (32+ characters)'
                ))
            
            if 'change-this' in jwt_secret.lower() or jwt_secret == 'secret':
                findings.append(VulnerabilityFinding(
                    severity='critical',
                    type='default_jwt_secret',
                    description='Using default or insecure JWT secret',
                    recommendation='Change JWT_SECRET to a secure random value'
                ))
            
            # Check database URL security
            db_url = os.getenv('DATABASE_URL', '')
            if 'password' in db_url.lower() and 'localhost' not in db_url:
                # Check if password is in plaintext in URL
                findings.append(VulnerabilityFinding(
                    severity='medium',
                    type='database_url_security',
                    description='Database URL may contain plaintext credentials',
                    recommendation='Use environment variables for sensitive database credentials'
                ))
            
        except Exception as e:
            logger.error(f"Configuration security check failed: {e}")
        
        return findings
    
    async def check_python_dependencies(self) -> List[VulnerabilityFinding]:
        """Check Python dependencies for vulnerabilities"""
        findings = []
        
        try:
            logger.info("Checking Python dependencies for vulnerabilities")
            
            # Run pip-audit if available
            try:
                result = subprocess.run(
                    ['pip-audit', '--format', 'json'],
                    capture_output=True,
                    text=True,
                    timeout=60
                )
                
                if result.returncode == 0 and result.stdout:
                    audit_data = json.loads(result.stdout)
                    vulnerabilities = audit_data.get('vulnerabilities', [])
                    
                    for vuln in vulnerabilities:
                        findings.append(VulnerabilityFinding(
                            severity=self._map_pip_severity(vuln.get('severity', 'low')),
                            type='dependency_vulnerability',
                            description=f"Vulnerable package: {vuln.get('name', 'unknown')}",
                            recommendation=f"Update to version {vuln.get('fixed_version', 'latest')}",
                            location=vuln.get('name', 'unknown')
                        ))
                        
            except FileNotFoundError:
                logger.warning("pip-audit not installed, skipping dependency scan")
            except subprocess.TimeoutExpired:
                logger.warning("pip-audit timed out")
            except Exception as e:
                logger.warning(f"pip-audit failed: {e}")
                
        except Exception as e:
            logger.error(f"Dependency check failed: {e}")
        
        return findings
    
    async def run_database_scan(self, db: Session) -> Dict[str, Any]:
        """Run database-specific security scan"""
        start_time = datetime.now()
        
        try:
            logger.info("Starting database security scan")
            
            result = db.execute(text("""
                INSERT INTO vulnerability_scans (scan_type, status, started_at)
                VALUES (:type, :status, NOW())
                RETURNING id
            """), {'type': 'Database Security Scan', 'status': 'in_progress'})
            scan_id = result.fetchone()[0]
            db.commit()
            
            findings = await self.check_database_security(db)
            severity = self._calculate_overall_severity(findings)
            duration = int((datetime.now() - start_time).total_seconds())
            
            db.execute(text("""
                UPDATE vulnerability_scans 
                SET status = :status, severity = :severity, findings = :findings,
                    scan_results = :results, completed_at = NOW(), duration_seconds = :duration
                WHERE id = :id
            """), {
                'status': 'completed',
                'severity': severity,
                'findings': len(findings),
                'results': json.dumps([f.to_dict() for f in findings]),
                'duration': duration,
                'id': scan_id
            })
            db.commit()
            
            logger.info(f"Database scan completed: {len(findings)} findings")
            
            return {
                'status': 'completed',
                'scan_id': scan_id,
                'findings': len(findings),
                'severity': severity
            }
            
        except Exception as e:
            logger.error(f"Database scan failed: {e}")
            return {'status': 'failed', 'error': str(e)}
    
    def _calculate_overall_severity(self, findings: List[VulnerabilityFinding]) -> str:
        """Calculate overall severity from findings"""
        if any(f.severity == 'critical' for f in findings):
            return 'critical'
        if any(f.severity == 'high' for f in findings):
            return 'high'
        if any(f.severity == 'medium' for f in findings):
            return 'medium'
        if len(findings) > 0:
            return 'low'
        return 'info'
    
    def _map_pip_severity(self, pip_severity: str) -> str:
        """Map pip-audit severity to our severity levels"""
        severity_map = {
            'critical': 'critical',
            'high': 'high',
            'moderate': 'medium',
            'medium': 'medium',
            'low': 'low'
        }
        return severity_map.get(pip_severity.lower(), 'low')


# Global vulnerability scanner instance
vulnerability_scanner = VulnerabilityScanner()
